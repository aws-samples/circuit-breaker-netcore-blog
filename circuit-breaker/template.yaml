AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  SAM Template for circuit breaker pattern

Resources:

  CircuitBreakerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: 'SamCircuitBreaker-CircuitBreakerLogGroup'

  CircuitBreakerStateMachine:
    Type: AWS::Serverless::StateMachine # More info about State Machine Resource: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-statemachine.html
    Properties:
      Type: STANDARD  # STANDARD or EXPRESS
      DefinitionUri: statemachine/circuitbreaker.asl.json
      DefinitionSubstitutions:
        GetCircuitStatusFunctionArn: !GetAtt GetCircuitStatusFunction.Arn
        UpdateCircuitStatusFunctionArn: !GetAtt UpdateCircuitStatusFunction.Arn
      Role: !GetAtt CircuitBreakerStateMachineRole.Arn
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt CircuitBreakerLogGroup.Arn
        IncludeExecutionData: true
        Level: 'ALL'
      Tracing:
        Enabled: true

  #Execution Role for StepFunctions
  CircuitBreakerStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - states.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'cloudwatch:*'
                  - 'logs:*'
                Resource: '*'
        - PolicyName: LambdaInvoke
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'lambda:InvokeFunction'
                Resource: 
                  - !GetAtt GetCircuitStatusFunction.Arn
                  - !GetAtt UpdateCircuitStatusFunction.Arn
                  # Include below the Lambda Function ARNs that are allowed as a TargetLambda                  
                  - !GetAtt TestCircuitBreakerFunction.Arn
                  - !GetAtt HelloWorldFunction.Arn

  GetCircuitStatusFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: ./GetCircuitStatusLambda/src/GetCircuitStatusLambda/
      Handler: GetCircuitStatusLambda::GetCircuitStatusLambda.GetCircuitStatus::FunctionHandler
      Runtime: dotnet6
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
             !Ref CircuitBreakerTable
      Tracing: Active

  UpdateCircuitStatusFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: ./UpdateCircuitStatusLambda/src/UpdateCircuitStatusLambda/
      Handler: UpdateCircuitStatusLambda::UpdateCircuitStatusLambda.UpdateCircuitStatus::FunctionHandler
      Runtime: dotnet6
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName:
             !Ref CircuitBreakerTable
      Tracing: Active

  TestCircuitBreakerFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: ./TestCircuitBreaker/src/TestCircuitBreaker/
      Handler: TestCircuitBreaker::TestCircuitBreaker.Function::FunctionHandler
      Runtime: dotnet6
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 30
      Tracing: Active
  
  HelloWorldFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: ./HelloWorld/src/HelloWorld/
      Handler: HelloWorld::HelloWorld.Function::FunctionHandler
      Runtime: dotnet6
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 30
      Tracing: Active

  CircuitBreakerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: CircuitBreaker
      AttributeDefinitions:
        - AttributeName: ServiceName
          AttributeType: S
        - AttributeName: HiResTimeStamp
          AttributeType: N
      KeySchema:
        - AttributeName: ServiceName
          KeyType: HASH
        - AttributeName: HiResTimeStamp
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TimeToLiveSpecification:
        AttributeName: ExpireTimeStamp
        Enabled: true
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
      
